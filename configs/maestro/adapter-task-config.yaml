# Example HyperFleet Adapter task configuration
apiVersion: hyperfleet.redhat.com/v1alpha1
kind: AdapterTaskConfig
metadata:
  name: example1-maestro-namespace
  labels:
    hyperfleet.io/adapter-type: maestro-namespace
    hyperfleet.io/component: adapter
spec:
  # Parameters with all required variables
  params:

    - name: "clusterId"
      source: "event.id"
      type: "string"
      required: true

    - name: "generationId"
      source: "event.generation"
      type: "int"
      required: true

    - name: "simulateResult"
      source: "env.SIMULATE_RESULT"
      type: "string"
      required: true

    - name: "placementClusterName"
      source: "event.placementClusterName"
      type: "string"
      required: true


  # Preconditions with valid operators and CEL expressions
  preconditions:
    - name: "clusterStatus"
      apiCall:
        method: "GET"
        url: "/clusters/{{ .clusterId }}"
        timeout: 10s
        retryAttempts: 3
        retryBackoff: "exponential"
      capture:
        - name: "clusterName"
          field: "name"
        - name: "generationId"
          field: "generation"
        - name: "timestamp"
          field: "created_time"
        - name: "readyConditionStatus"
          expression: |
            status.conditions.filter(c, c.type == "Ready").size() > 0
              ? status.conditions.filter(c, c.type == "Ready")[0].status
              : "False"

        # - name: "placementClusterName"
        #   expression: "\"cluster1\""  # TBC coming from placement adapter
        #   description: "Unique identifier for the target maestro"

        - name: "adapterName"
          expression: "\"adapter1\""  # TBC coming from config passed to params
          description: "Unique identifier for the adapter"

      # Structured conditions with valid operators
      conditions:
        - field: "readyConditionStatus"
          operator: "equals"
          value: "False"

    - name: "validationCheck"
      # Valid CEL expression
      expression: |
        readyConditionStatus == "False"

  # Resources with valid K8s manifests
  resources:
    - name: "agentNamespaceManifestWork"
      transport:
        client: "maestro"
        maestro:
          targetCluster: "{{ .placementClusterName }}"
      
      # ManifestWork is a kind of manifest that can be used to create resources on the cluster.
      # It is a collection of resources that are created together.
      # It is created by the adapter and can be used to create resources on the cluster.
      # It is created by the adapter and can be used to create resources on the cluster.
      manifest:
        ref: "./adapter-task-resource-manifestwork.yaml"
      
      # Discover the manifestWork by name
      # This is used to get the manifestWork object from the cluster.
      # With this approach, the manifestWork object can be used to get the resources inside the manifestWork.
      # When try to dig  Manifest
      discovery:
        byName: "hyperfleet-cluster-setup-{{ .clusterId }}"

      # Discover sub-resources within the manifestWork
      # This approach can be used to use the discovery name to parameter level, in case of the manifestName is dynamicly changed with clusterID
      # This can support jsonPath to dig into the resource status. like mgmtNamespace.status.conditions[?(@.type=="Ready")].status
      nestedDiscoveries:
        - name: "mgmtNamespace"
          discovery:
            bySelectors:
              labelSelector:
                hyperfleet.io/resource-type: "namespace"
                hyperfleet.io/cluster-id: "{{ .clusterId }}"  
        - name: "mgmtConfigMap"
          discovery:
            byName: "cluster-config"

  # Post-processing with valid CEL expressions
  # This example contains multiple resources, we will only report on the conditions of the jobNamespace not to overcomplicate the example
  post:
    payloads:
      - name: "clusterStatusPayload"
        build:
          # Adapter name for tracking which adapter reported this status
          adapter: "{{ .metadata.name }}"
          
          # Conditions array - each condition has type, status, reason, message
          # Use CEL optional chaining ?.orValue() for safe field access
          conditions:
            # Applied: Resources successfully created
            - type: "Applied"
              status:
                expression: |
                  resources.?agentNamespaceManifestWork.agentNamespace.?status.?phase.orValue("") == "Active" ? "True" : "False"
              reason:
                expression: |
                  resources.?agentNamespaceManifestWork.agentNamespace.?status.?phase.orValue("") == "Active"
                    ? "NamespaceCreated"
                    : "NamespacePending"
              message:
                expression: |
                  resources.?agentNamespaceManifestWork.agentNamespace.?status.?phase.orValue("") == "Active"
                    ? "Namespace created successfully"
                    : "Namespace creation in progress"

            # Available: Resources are active and ready
            - type: "Available"
              status:
                expression: |
                  resources.?agentNamespaceManifestWork.agentNamespace.?status.?phase.orValue("") == "Active" ? "True" : "False"
              reason:
                expression: |
                  resources.?agentNamespaceManifestWork.agentNamespace.?status.?phase.orValue("") == "Active" ? "NamespaceReady" : "NamespaceNotReady"
              message:
                expression: |
                  resources.?agentNamespaceManifestWork.agentNamespace.?status.?phase.orValue("") == "Active" ? "Namespace is active and ready" : "Namespace is not active and ready"

            # Health: Adapter execution status (runtime) Don't need to update this. This can be reused from the adapter config.
            - type: "Health"
              status:
                expression: |
                  adapter.?executionStatus.orValue("") == "success" ? "True" : (adapter.?executionStatus.orValue("") == "failed" ? "False" : "Unknown")
              reason:
                expression: |
                  adapter.?errorReason.orValue("") != "" ? adapter.?errorReason.orValue("") : "Healthy"
              message:
                expression: |
                  adapter.?errorMessage.orValue("") != "" ? adapter.?errorMessage.orValue("") : "All adapter operations completed successfully"
          
          # Use CEL expression for numeric fields to preserve type (not Go template which outputs strings)
          observed_generation:
            expression: "generationId"
            
          # Use Go template with now and date functions for timestamps
          observed_time: "{{ now | date \"2006-01-02T15:04:05Z07:00\" }}"

          # Optional data field for adapter-specific metrics extracted from resources
          data:
            namespace:
              name:
                expression: |
                  resources.?clusterNamespace.?metadata.?name.orValue("")
              status:
                expression: |
                  resources.?clusterNamespace.?status.?phase.orValue("")

    postActions:
      - name: "reportClusterStatus"
        apiCall:
          method: "POST"
          url: "/clusters/{{ .clusterId }}/statuses"
          headers:
            - name: "Content-Type"
              value: "application/json"
          body: "{{ .clusterStatusPayload }}"
